### [Chinese Version / 中文版](README.md)

## Overall Architecture Diagram
![image](https://github.com/user-attachments/assets/37b8870d-2032-4425-b081-73c35eaa1a93)

## Log Collector Microservice
1. Provides a unified framework to collect logs from various existing systems.
2. Provides functionality to query logs from various systems.
3. Enhances maintainability and scalability through microservice architecture.

### Usage Instructions

Please use the following commands to build and run the container:

#### Build Image
- Execute `podman build -t logger .` in the `/container/logger` directory.
- Execute `podman build -t container .` in the `/container/container` directory.
- `podman pull mysql:8.0`

#### Create Containers
Please note, it is recommended to create a folder to store the mysql-db data. The absolute path of this folder is represented as `<absolute path to data>` in the commands below:
```
podman pod create --name log-collector-microservice -p 5050:5050 -p 5000:5000
podman run -d --pod log-collector-microservice --name collector collector:latest
podman run -d --pod log-collector-microservice --name logger logger:latest
podman run -d --pod log-collector-microservice --name mysql-db \
              -e MYSQL_ROOT_PASSWORD=<your-password> \
              -v <absolute path to data>:/var/lib/mysql \
              mysql:8.0
```

#### Create Database
1. `podman exec -it mysql-db bash`
2. `mysql -h 127.0.0.1 -u root -p`
3. Enter the `MYSQL_ROOT_PASSWORD` set during container creation.
4. Execute the following commands to create a user account for the logger:
   (Note: The username and password here should match the environment variables used in the `Dockerfile` of the `logger` folder; the following are default credentials)
   ```
   CREATE USER 'oraclelee'@'%' IDENTIFIED BY '0000';
   GRANT ALL PRIVILEGES ON logger.* TO 'oraclelee'@'%';
   ```
5. Execute the following commands to create the database and table:
   (Note: The database and table names should match the environment variables used in the `Dockerfile` of the `logger` folder; the following are default names)
   ```
   CREATE DATABASE IF NOT EXISTS logger;
   USE logger;
   CREATE TABLE IF NOT EXISTS log_data (
       ID INT AUTO_INCREMENT PRIMARY KEY,
       HOST_NAME VARCHAR(32),
       HOST_IP VARCHAR(15),
       SYSTEM_TYPE VARCHAR(20),
       LEVEL VARCHAR(6),
       PROCESS_NAME VARCHAR(64),
       CONTENT VARCHAR(512),
       LOG_TIME DATETIME,
       TIMESTAMP TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
   );
   ```

## Processor

`processor.py` is a program responsible for sending various log formats generated by client processes to the database. It reads the configuration files from the `config` folder and sends JSON formatted data to the microservice (collector) that handles raw data splitting.

### Usage Instructions

#### Install Required Packages
```
sudo apt update
sudo apt install pip
pip install requests
pip install watchdog
pip install pyyaml
```

#### Run the Program

Before running the program, modify the locations of `config.cfg` and `offset.json` in the main function, as well as the collector URL.
```python3
def main():
    config_file = '<path to config.cfg>'
    offsets_file = '<path to offset.json>'
    # e.g., offsets_file = f'/home/oraclelee/Desktop/log-collector-microservice/config/offsets{date.today()}.json'
    collector_url = '<collector URL>'  # Change the URL to a parameter
```

After making these changes, execute the following command:

`python3 processor.py`

## API Documentation UI
Collector Swagger
```
podman run -d --name collector_swagger -p 8080:8080 \
                -e SWAGGER_JSON=/foo/openapi.yaml \
                -v <absolute path to collector_openapi.yaml>:/foo/openapi.yaml \
                swaggerapi/swagger-ui
```
Logger Swagger
```
podman run -d --name logger_swagger -p 8081:8080 \
                -e SWAGGER_JSON=/foo/openapi.yaml \
                -v <absolute path to logger_openapi.yaml>:/foo/openapi.yaml \
                swaggerapi/swagger-ui
```

### Access Web UI
- Log searching: Please enter in your browser `http://localhost:5000`
- Collector API documentation: `http://localhost:8080`
- Logger API documentation: `http://localhost:8081`

## Automated testing
The `test_auto_logger.py` file, situated within the logger directory, is specifically designed for automated testing of the logging module. After installing the pytest framework using `pip install pytest`, you can run the tests directly by executing `pytest test_auto_logger.py`.

## Detailed Description
For more comprehensive project desciption, please refer to [this hackmd document](https://hackmd.io/@OliverLin12/r1eEp6cs0).